/*
 * This file is part of Member Picture Feed.
 *
 * (c) Marko Cupic 2024 <m.cupic@gmx.ch>
 * @license GPL-3.0-or-later
 * For the full copyright and license information,
 * please view the LICENSE file that was distributed with this source code.
 * @link https://github.com/markocupic/member-picture-feed
 */"use strict";class MemberPictureFeedUploadApp{constructor(e,t,r){this.requestToken=e,this.pageId=t,this.pageLanguage=r}initialize(){let e;let t=this.requestToken,r=this.pageId,a=this.pageLanguage,o=document.querySelector(".modal.member-picture-feed-caption-modal");for(let r of["click","touchmove"]){let a=document.querySelectorAll(".remove-image");if(a)for(let o of a)o.addEventListener(r,function(r){r.preventDefault();let a=o.closest("[data-file-id]");if(a&&void 0!==(e=a.getAttribute("data-file-id"))){let r=new FormData;r.append("REQUEST_TOKEN",t),r.append("fileId",e),fetch("_member_picture_feed_xhr/remove_image",{method:"POST",headers:{"x-requested-with":"XMLHttpRequest",Accept:"application/json"},body:r}).then(e=>e.json()).then(e=>{e.message&&("success"===e.status||console.error(e.message)),"success"===e.status?(a.remove(),location.reload()):console.error("Server error!!!")}).catch(e=>{console.error("Error:",e)})}})}for(let r of["click","touchmove"]){let a=document.querySelectorAll(".rotate-image");if(a)for(let o of a)o.addEventListener(r,function(r){r.preventDefault();let a=o.closest("[data-file-id]");if(a&&void 0!==(e=a.getAttribute("data-file-id"))){let r=new FormData;r.append("REQUEST_TOKEN",t),r.append("fileId",e),fetch("_member_picture_feed_xhr/rotate_image",{method:"POST",headers:{"x-requested-with":"XMLHttpRequest",Accept:"application/json"},body:r}).then(e=>e.json()).then(e=>{e.message&&("success"===e.status||console.error(e.message)),"success"===e.status?location.reload():console.error("Server error!!!")}).catch(e=>{console.error("Error:",e)})}})}let s=document.querySelectorAll("button.add-caption");if(s)for(let n of s)n.addEventListener("click",s=>{s.preventDefault();let c=n.closest("[data-file-id]");if(c){e=c.getAttribute("data-file-id");let s=c.getAttribute("data-src");if(e){let n=bootstrap.Modal.getOrCreateInstance(o);o.querySelector(".image-full-res").setAttribute("src",s);let c=new FormData;c.append("REQUEST_TOKEN",t),c.append("pageLanguage",a),c.append("pageId",r),c.append("fileId",e),fetch("_member_picture_feed_xhr/get_image_data",{method:"POST",headers:{"x-requested-with":"XMLHttpRequest",Accept:"application/json"},body:c}).then(e=>e.json()).then(e=>{e.message&&("success"===e.status||console.error(e.message)),"success"===e.status?(document.getElementById("imageCaptionInput").value=e.caption,document.getElementById("imagePhotographerInput").value=e.photographer,n.show()):console.error("Server error!!!")}).catch(e=>{console.error("Error:",e)})}}});document.getElementById("saveCaptionButton").addEventListener("click",()=>{let r=bootstrap.Modal.getOrCreateInstance(o),s=(o.querySelector('[name="image-caption"]').value??"").trim(),n=o.querySelector('[name="image-photographer"]').value;r.hide();let c=new FormData;c.append("REQUEST_TOKEN",t),c.append("pageLanguage",a),c.append("caption",s),c.append("photographer",n),c.append("fileId",e),fetch("_member_picture_feed_xhr/set_caption",{method:"POST",headers:{"x-requested-with":"XMLHttpRequest",Accept:"application/json"},body:c}).then(e=>e.json()).then(e=>{e.message&&("success"===e.status||console.error(e.message))}).then(()=>{let t=document.querySelector('li.member-picture-feed-thumb[data-file-id="'+e+'"] button.add-caption');t&&(""!==s?t.dataset.hascaption="1":t.dataset.hascaption="")}).catch(e=>{console.error("Error:",e)})})}}